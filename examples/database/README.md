# Database Example

Full CRUD operations with PostgreSQL, type-safe SQL queries, and JSON validation.

## What This Demonstrates

- **PostgreSQL connection** - Using Pog for connection pooling
- **Type-safe SQL** - Squirrel-generated queries from SQL files
- **Model-Controller pattern** - Clean separation of concerns
- **JSON request validation** - Validating request bodies
- **Database error handling** - Proper error responses
- **Complete REST API** - Full CRUD operations

## Prerequisites

- Docker (for PostgreSQL)
- Gleam installed

## Running the Example

```bash
cd examples/database

# Start PostgreSQL database
make db-up

# Run database migrations
make migrate

# Start the server
make run
```

Server starts on `http://localhost:3002`

## Database Setup

The example uses its own PostgreSQL instance:
- **Port**: 5435
- **Database**: `dream_example_database_db`
- **User**: `postgres`
- **Password**: `postgres`

Connection URL: `postgres://postgres:postgres@localhost:5435/dream_example_database_db`

## API Endpoints

### Users

- `GET /users` - List all users
- `GET /users/:id` - Get one user
- `POST /users` - Create user (JSON body: `{"name":"Alice","email":"alice@example.com"}`)
- `PUT /users/:id` - Update user
- `DELETE /users/:id` - Delete user

### Posts

- `GET /users/:user_id/posts` - List user's posts
- `GET /posts/:id` - Get one post
- `POST /users/:user_id/posts` - Create post (JSON body: `{"title":"My Post","content":"Post content"}`)

## Example Usage

```bash
# List all users
curl http://localhost:3002/users

# Get a specific user
curl http://localhost:3002/users/1

# Create a user
curl -X POST http://localhost:3002/users \
  -H "Content-Type: application/json" \
  -d '{"name":"Alice","email":"alice@example.com"}'

# Update a user
curl -X PUT http://localhost:3002/users/1 \
  -H "Content-Type: application/json" \
  -d '{"name":"Alice Updated","email":"alice.updated@example.com"}'

# Delete a user
curl -X DELETE http://localhost:3002/users/1

# List posts for a user
curl http://localhost:3002/users/1/posts

# Create a post
curl -X POST http://localhost:3002/users/1/posts \
  -H "Content-Type: application/json" \
  -d '{"title":"My First Post","content":"This is my first post!"}'
```

## Code Structure

```
examples/database/
├── gleam.toml              # Project config
├── Makefile                # Build and database commands
├── docker-compose.yml      # PostgreSQL setup
├── priv/migrations/        # Database migrations
├── sql/                    # SQL query files (for Squirrel)
└── src/
    ├── main.gleam         # Application entry point
    ├── router.gleam       # Route definitions
    ├── context.gleam      # Database context type
    ├── database.gleam     # Database initialization
    ├── services.gleam     # Service initialization
    ├── sql.gleam          # Generated by Squirrel
    ├── controllers/
    │   ├── users_controller.gleam
    │   └── posts_controller.gleam
    └── models/
        ├── user.gleam
        └── post.gleam
```

## Database Commands

```bash
# Start database
make db-up

# Stop database
make db-down

# View database logs
make db-logs

# Access database shell
make db-shell

# Reset database (removes all data)
make db-reset

# Run migrations
make migrate

# Run migrations up
make migrate-up

# Run migrations down
make migrate-down

# Create new migration
make migrate-new name=my_migration
```

## Key Concepts

- **Database Service** - Singleton pattern for connection management
- **Squirrel** - Generates type-safe Gleam functions from SQL files
- **Migrations** - Using Cigogne for database schema management
- **Models** - Data conversion and validation
- **Controllers** - HTTP request handling and routing to models

This example shows how to build a complete REST API with Dream and PostgreSQL.

